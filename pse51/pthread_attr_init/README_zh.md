# pthread_attr_init, pthread_attr_destroy - 初始化和销毁线程属性对象

## 概要

```c
#include <pthread.h>

int pthread_attr_init(pthread_attr_t *attr);
int pthread_attr_destroy(pthread_attr_t *attr);
```

## 描述

`pthread_attr_destroy()` 函数应销毁一个线程属性对象。实现可能导致 `pthread_attr_destroy()` 将 `attr` 设置为实现定义的无效值。已销毁的 `attr` 属性对象可以使用 `pthread_attr_init()` 重新初始化；在对象被销毁后以其他方式引用该对象的结果是未定义的。

`pthread_attr_init()` 函数应使用给定实现所使用的所有单个属性的默认值来初始化线程属性对象 `attr`。

当由 [`pthread_create()`](pthread_create.html) 使用时，生成的属性对象（可能通过设置单个属性值来修改）定义了所创建线程的属性。单个属性对象可以在多次并发调用 [`pthread_create()`](pthread_create.html) 中使用。如果调用 `pthread_attr_init()` 时指定了已初始化的 `attr` 属性对象，则结果是未定义的。

如果传递给 `pthread_attr_destroy()` 的 `attr` 参数值不引用已初始化的线程属性对象，则行为是未定义的。

## 返回值

成功完成后，`pthread_attr_init()` 和 `pthread_attr_destroy()` 应返回零；否则，应返回错误编号以指示错误。

## 错误

`pthread_attr_init()` 和 `pthread_attr_destroy()` 函数在以下情况下应失败：

- **ENOMEM** - 存在的内存不足以初始化线程属性对象。

`pthread_attr_init()` 函数在以下情况下可能失败：

- **EBUSY** - `attr` 指定的值引用已初始化的线程属性对象。

`pthread_attr_destroy()` 函数在以下情况下可能失败：

- **EINVAL** - `attr` 指定的值不引用已初始化的线程属性对象。

这些函数不应返回 [`EINTR`](errno.html) 错误码。

## 示例

无。

## 应用程序用法

为线程、互斥量和条件变量提供了属性对象，作为一种机制，用于支持这些领域中可能的未来标准化，而无需更改函数本身。

属性对象提供了线程可配置方面的清晰隔离。例如，"栈大小"是线程的一个重要属性，但它无法以可移植的方式表达。在移植线程程序时，通常需要调整栈大小。使用属性对象可以通过允许将更改隔离在单个位置来提供帮助，而不是分散在每次线程创建的实例中。

属性对象可用于设置具有相似属性的线程"类"；例如，"具有大栈和高优先级的线程"或"具有最小栈的线程"。这些类可以在单个位置定义，然后在需要创建线程的任何地方引用。对"类"决策的更改变得直接明了，并且不需要对每个 [`pthread_create()`](pthread_create.html) 调用进行详细分析。

## 基本原理

属性对象被定义为不透明类型，以有助于扩展性。如果这些对象被指定为结构，则在属性对象被扩展时，添加新属性将强制重新编译所有多线程程序；如果不同的程序组件由不同的供应商提供，这可能是不可能的。

此外，不透明的属性对象提供了提高性能的机会。属性的有效性可以在设置属性时检查一次，而不是在每次创建线程时都检查。实现通常需要缓存创建成本高昂的内核对象。不透明属性对象提供了一种高效的机制来检测缓存的对象何时因属性更改而失效。

由于赋值在给定的不透明类型上不一定被定义，实现定义的默认值无法以可移植的方式定义。这个问题的解决方案是允许属性对象通过属性对象初始化函数动态初始化，以便实现可以自动提供默认值。

栈大小被定义为可选属性，因为栈的概念本身就是机器依赖的。例如，一些实现可能无法更改栈的大小，而其他实现可能不需要，因为栈页可能是不连续的，可以按需分配和释放。

属性机制在很大程度上是为可扩展性而设计的。对属性机制或 POSIX.1-2024 卷中定义的任何属性对象的未来扩展必须谨慎进行，以免影响二进制兼容性。

属性对象，即使是通过诸如 [`malloc()`](malloc.html) 等动态分配函数分配的，其大小也可能在编译时固定。这意味着，例如，在具有 `pthread_attr_t` 扩展的实现中的 [`pthread_create()`](pthread_create.html) 不能查看超出二进制应用程序假设为有效的区域。这表明实现应在属性对象中维护大小字段，以及可能的版本信息，如果要适应不同方向（可能由不同供应商）的扩展。

如果实现检测到传递给 `pthread_attr_destroy()` 的 `attr` 参数值不引用已初始化的线程属性对象，建议函数应失败并报告 `[EINVAL]` 错误。

如果实现检测到传递给 `pthread_attr_init()` 的 `attr` 参数值引用已初始化的线程属性对象，建议函数应失败并报告 `[EBUSY]` 错误。

## 未来方向

无。

## 另请参阅

[`pthread_create()`](pthread_create.html), [`malloc()`](malloc.html)

POSIX.1-2024 基础定义卷，`<pthread.h>`

## 更改历史

首次发布于 Issue 5。包含在 Issue 6 (IEEE Std 1003.1, 2004) 中。

---
